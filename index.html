<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Controle de Cor</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
input, button { margin: 8px 0; padding: 6px; display: block; width: 100%; max-width: 320px; }
button { background: #2b7cff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; }
button:hover { background: #1e5bcc; }
img { max-width: 150px; margin: 8px; border: 1px solid #ccc; border-radius: 4px; }
#res { margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>
<h2>Registro de Controle de Cor</h2>
<label>Operador:<br><input id="operador" required></label>
<label>Lote:<br><input id="lote" required></label>
<label>Foto Master:<br><input type="file" id="fotoMaster" accept="image/*"></label>
<label>Foto Nova:<br><input type="file" id="fotoNova" accept="image/*"></label>
<button onclick="enviar()">Enviar para an√°lise</button>
<div id="res"></div>

<script>
function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(",")[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function enviar() {
  const master = document.getElementById("fotoMaster").files[0];
  const nova = document.getElementById("fotoNova").files[0];
  const operador = document.getElementById("operador").value.trim();
  const lote = document.getElementById("lote").value.trim();

  if (!operador || !lote) return alert("Preencha operador e lote!");
  if (!master || !nova) return alert("Envie as duas fotos!");

  const data = {
    operador,
    lote,
    masterImage: await toBase64(master),
    newImage: await toBase64(nova)
  };

  document.getElementById("res").innerText = "üì§ Enviando dados, aguarde...";

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbzlAczpO8pMdTPV5Zp_L1wdN_l3T91tbL9TiOBNMdycHqsRgOVn8sqvc7kVgDtXll3ZKw/exec", {
      method: "POST",
      headers: {
        "Content-Type": "application/json" // ‚úÖ Adicionado cabe√ßalho correto
      },
      body: JSON.stringify(data)
    });

    // üîç Garante que a resposta √© JSON
    const text = await response.text();
    let json;
    try {
      json = JSON.parse(text);
    } catch (err) {
      throw new Error("Resposta inesperada do servidor:\n" + text);
    }

    if (json.status === "ok") {
      document.getElementById("res").innerText = "‚úÖ Registro salvo com sucesso!";
    } else {
      document.getElementById("res").innerText = "‚ùå Erro: " + json.message;
    }

  } catch (err) {
    document.getElementById("res").innerText = "‚ùå Falha de conex√£o: " + err.message;
  }
}
</script>
</body>
</html>
